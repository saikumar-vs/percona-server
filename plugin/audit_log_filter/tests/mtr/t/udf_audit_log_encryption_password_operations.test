--source include/have_component_keyring_file.inc
--source suite/component_keyring_file/inc/setup_component.inc

--disable_query_log
call mtr.add_suppression("Failed to shutdown components infrastructure.");
--enable_query_log

--echo #
--echo # Get current password
--replace_regex /"password":"\w*"/"password":"pwd"/ /"iterations":\d*/"iterations":1000/ /"salt":"\w*"/"salt":"ffffffffffffffff"/
SELECT audit_log_encryption_password_get();

--echo #
--echo # Check passwords sequence
SET GLOBAL DEBUG='+d,audit_log_filter_debug_timestamp';

SELECT audit_log_encryption_password_set('pwd1');
SELECT audit_log_encryption_password_set('pwd2');
SELECT audit_log_encryption_password_set('pwd3');

CREATE TABLE tmp(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                 key_id VARCHAR(1024));

INSERT INTO tmp (key_id)
SELECT KEY_ID FROM performance_schema.keyring_keys
WHERE KEY_ID LIKE 'audit_log%' ORDER BY KEY_ID DESC;

--let $count = `SELECT count(*) FROM tmp`

# Skip first record, that is autogenerated initial password with not yet masked timestamp
while ($count > 1) {
  --let $key_id = `SELECT key_id FROM tmp WHERE id = $count`
  --replace_regex /"iterations":\d*/"iterations":1000/ /"salt":"\w*"/"salt":"ffffffffffffffff"/
  eval SELECT audit_log_encryption_password_get('$key_id');
  dec $count ;
}

--source suite/component_keyring_file/inc/teardown_component.inc

--echo #
--echo # Cleanup
SET GLOBAL DEBUG='-d,audit_log_filter_debug_timestamp';

DROP TABLE tmp;
